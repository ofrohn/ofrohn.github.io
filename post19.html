<!DOCTYPE html>
<html>
<head>
  <title>Geolocator</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
</style>
</head><body>
  <script type='text/javascript' src="https://d3js.org/topojson.v1.min.js"></script>
  <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
  <script type="text/javascript" src="https://ofrohn.github.io/lib/planetaryjs.min.js"></script>
  <script type="text/javascript" src="https://ofrohn.github.io/celestial.js"></script>
  <link rel="stylesheet" href="https://ofrohn.github.io/celestial.css">
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
<style type="text/css">
#celestial-map18 { height: auto; margin: 0; padding: 0; display: inline-block; left:260px; z-index:11;  }
#celestial-map18 canvas { display: inline-block; position:absolute; z-index:0; cursor:crosshair; }
pre.prettyprint { display: inline-block; width:720px; border-radius:3px; }
div.clbox { top:0; left:0; width: 920px; height:640px; }
div.clbox div { position: absolute; display: inline-block;  }

@media screen {
  .str { color: #008 }  /* string content */
  .kwd { color: #000; font-weight: bold; }  /* a keyword */
  .com { color: #080 }  /* a comment */
  .typ { color: #606 }  /* a type name */
  .lit { color: #066 }  /* a literal value */
  /* punctuation, lisp open bracket, lisp close bracket */
  .pun, .opn, .clo { color: #660 }
  .tag { color: #008 }  /* a markup tag name */
  .atn { color: #606 }  /* a markup attribute name */
  .atv { color: #080 }  /* a markup attribute value */
  .dec, .var { color: #606 }  /* a declaration; a variable name */
  .fun { color: red }  /* a function name */
}

/* Use higher contrast and text-weight for printable form. */
@media print, projection {
  .str { color: #006 }
  .kwd { color: #000; font-weight: bold }
  .com { color: #060; font-style: italic }
  .typ { color: #404; font-weight: bold }
  .lit { color: #044 }
  .pun, .opn, .clo { color: #440 }
  .tag { color: #006; font-weight: bold }
  .atn { color: #404 }
  .atv { color: #060 }
}
  #celestial-map canvas  { }
</style>

<div class="clbox" style="overflow:hidden;margin:0;width:600px" ><div id="celestial-map18"></div><div style="margin:0; width:300px; left:10px; top:340px;z-index:1"><canvas id='geoSelect' width='300' height='300' style='width: 300px; height: 300px; cursor: crosshair;'></canvas></div>
</div>
<div id="celestial-form"></div>

<p>I was looking for a simple graphical location-selector, a globe that can be spun, zoomed in and clicked on to get an approximate location.
I found none so obviously I had to make my own. A good starting point was <a href="https://github.com/BinaryMuse/planetary.js">planetary.js</a> which already takes care of the spinnable and zoomable globe and is pretty easy to extend with plugins. See my fork for details about the nouse-actions plugin.</p>

<p>All the work is done in a callback function for the mouse actions mousedown and mouseup. We could just use click, but that would alse cause a positioning update on dragging actions on the globe. Only updating when the mouse coordinates dont change between down and up takes care of that. The rest is pretty straight forward, take mouse coordinates, calculate geographic position with the d3.js function projection.invert, and if that is valid (i.e. inside the globe) update the geolocation of the sky view.</p>

<pre class="prettyprint">
  globe.loadPlugin(mouse({
    onMousedown: function() {
      var x = d3.event.offsetX,
          y = d3.event.offsetY;
      position = [x, y];
    },
    onMouseup: function() {
      var x = d3.event.offsetX,
          y = d3.event.offsetY,
          format = d3.format("+.3f");
      if (position[0] !== x || position[1] !== y) return;

      var pos = this.projection.invert([x,y]);
      if (!isNaN(pos[0])) {
        // latitude, longitude convention is the opposite for sky coordinates
        Celestial.skyview({"location": [format(pos[1]), format(pos[0])]});
      }   
      return pos;
    }
  }));
</pre></p>

<p>Time zones are not taken into account yet, so the result is not necessarily valid. That will be fixed later, as well as putting a position marker on the globe globe, showing the current terminator between day and night, and optionally also show the current sky state on the current view changing between blue and transparent.</p>

<script type="text/javascript">

// Some prettifying styles
var config = { 
  width:600,
  projection: "orthographic", 
  center: [-65, 0],
  //follow: "center",
  background: { fill: "#000", stroke: "#999", opacity: 1, width: 1 },
  location: true,
  controls: false,
  interactive: false,
  container: "celestial-map18", 
  datapath: "https://ofrohn.github.io/data/",
  stars: { 
    colors: false, 
    names: false, 
    style: { fill: "#fff", opacity:1 }, 
    limit: 6, 
    size:5 
  },
  dsos: { 
    show: true,    
    colors: false,  // Show DSOs in symbol colors, if not use fill-style
    style: { fill: "#cccccc", stroke: "#cccccc", width: 2, opacity: 1 }, // Default style for dsos
    names: true,   //Show DSO names
    namestyle: { fill: "#cccccc", font: "12px 'Lucida Sans Unicode', Trebuchet, Helvetica, Arial, sans-serif", align: "left", baseline: "bottom" }
  },
  mw: { 
    style: { fill:"#fff", opacity: 0.1 } 
  },
  planets: {  //Show planet locations
    show: true
  }
};

/* ToDo:
Get time zone
Position marker on globe
Show current terminator
Show sky brightness overlay [opt]


*/

(function() {
  var globe = planetaryjs.planet(),
      position = [];
  globe.loadPlugin(planetaryjs.plugins.earth({
    topojson: { file:   'https://ofrohn.github.io/data/world-110m-withlakes.json' },
    oceans:   { fill:   '#ccd' },
    land:     { fill:   '#fed' },
    borders:  { stroke: '#999' }
  }));
  globe.loadPlugin(lakes({ fill: '#ccd' }));

  globe.loadPlugin(planetaryjs.plugins.zoom({ scaleExtent: [150, 2500] }));
  globe.loadPlugin(planetaryjs.plugins.drag());

  globe.projection.scale(150).translate([150, 150]).rotate([0, -10, 0]);

  globe.loadPlugin(mouse({
    onMousedown: function() {
      var x = d3.event.offsetX,
          y = d3.event.offsetY;
      position = [x, y];
    },
    onMouseup: function() {
      var x = d3.event.offsetX,
          y = d3.event.offsetY,
          format = d3.format("-.3f");
      if (position[0] !== x || position[1] !== y) return;

      var pos = this.projection.invert([x,y]);
      if (!isNaN(pos[0])) {
        setPosition(pos);
        Celestial.skyview({"location": [format(pos[1]), format(pos[0])]});
      }   
      return pos;
    }
  }));
  
   function setPosition(pos) {
     var p = pos[1] + "%2C" + pos[0],
         url = "https://api.askgeo.com/v1/2168/c6897c7ab128057a9c0e815886e89ca4a259343010526e9620e733f689f22745/query.json?databases=Point,TimeZone,Astronomy&points=" + p + "&dateTime=" + Celestial.date().getTime();
      d3.json(url ,function(error, json) {
      if (error) { 
        return console.log(error);  
      }
      var tz = json; 
    })
  
  }
  
  
  var canvas = document.getElementById('geoSelect');

  if (window.devicePixelRatio == 2) {
    canvas.width = 600;
    canvas.height = 600;
    context = canvas.getContext('2d');
    context.scale(2, 2);
  }

  globe.draw(canvas);

  function lakes(options) {
    options = options || {};
    var lakes = null;

    return function(planet) {
      planet.onInit(function() {
        // We can access the data loaded from the TopoJSON plugin
        // on its namespace on `planet.plugins`. We're loading a custom
        // TopoJSON file with an object called "ne_110m_lakes".
        var world = planet.plugins.topojson.world;
        lakes = topojson.feature(world, world.objects.ne_110m_lakes);
      });

      planet.onDraw(function() {
        planet.withSavedContext(function(context) {
          context.beginPath();
          planet.path.context(context)(lakes);
          context.fillStyle = options.fill || 'black';
          context.fill();
        });
      });
    };
  };

  function mark(options) {
    options = options || {};

    return function(planet) {
      planet.onDraw(function() {
        planet.withSavedContext(function(context) {
          context.beginPath();
          // draw marker
          context.fillStyle = options.fill || 'black';
          context.fill();
        });
      });
 
    };
  };

  // This plugin exposes mouse actions.
  function mouse(options) {
    options = options || {};
    var noop = function() {},
        onClick = options.onClick || noop,
        onMousedown = options.onMousedown || noop,
        onMousemove = options.onMousemove || noop,
        onMouseup = options.onMouseup || noop;


    return function(planet) {
   
      planet.onInit(function() {
         d3.select(planet.canvas).on('click', onClick.bind(planet));
         d3.select(planet.canvas).on('mousedown', onMousedown.bind(planet));
         d3.select(planet.canvas).on('mousemove', onMousemove.bind(planet));
         d3.select(planet.canvas).on('mouseup', onMouseup.bind(planet));
      });

    };
  };

})();

  Celestial.display(config);
 
</script>
 
<footer id="d3-celestial-footer">
<p><a href="https://github.com/ofrohn/d3-celestial"><b>D3-Celestial</b></a> released under <a href="http://opensource.org/licenses/BSD-3-Clause">BSD license</a>. Copyright 2015-19 <a href="http://armchairastronautics.blogspot.com/" rel="author">Olaf Frohn</a>.
</p></footer> 
 <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', 'UA-105720254-1', 'auto');ga('send', 'pageview');</script>
</body>
</html>
